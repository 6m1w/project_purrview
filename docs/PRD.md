# PurrView 产品需求文档

## 项目概述

PurrView 是一个猫咪喂食监控系统，通过现有的 RTMP 摄像头（俯视固定角度）实时监控 5 只猫的进食行为。系统使用 OpenCV 作为低成本运动检测门控，配合 Gemini 多模态 API 进行智能分析（猫咪识别 + 食物量估算），无需自定义 ML 训练。

**域名**: purrview.dev

## 核心功能

### 1. 实时流处理（Stream Worker）
- 通过 ffmpeg 从 RTMP 摄像头提取帧（每 2 秒 1 帧）
- OpenCV MOG2 背景减除算法检测食盆区域的运动
- 运动检测到后触发 Gemini API 分析
- 冷却机制：触发后 30 秒内不重复调用 API

### 2. AI 分析
- **猫咪识别**：基于预上传的参考照片，通过 few-shot 方式让 Gemini 识别是哪只猫
- **进食判断**：判断猫是否正在进食
- **食物量估算**：估算食盆中的食物水平（满/3/4/1/2/1/4/空）
- **结构化输出**：使用 Pydantic schema 确保 JSON 响应格式一致

### 3. 进食事件追踪
- 状态机：空闲 → 活跃（检测到运动）→ 进食中（AI 确认）→ 空闲（2 分钟无运动）
- 将连续帧组合为单个进食事件
- 记录：首帧、过程中周期帧、末帧

### 4. Web 仪表板
- **总览页**：今日进食次数、已喂食猫数、活跃食盆数、最近进食时间
- **猫咪管理**：添加/编辑猫咪资料，上传参考照片
- **进食时间线**：今日事件列表，带缩略帧图片
- **统计报表**：每日/每周图表，每只猫的进食趋势

## 用户场景

### 场景 1：日常监控
Lin 早上打开 PurrView 仪表板，查看昨晚到今早有哪些猫吃了东西，每只猫吃了多少。

### 场景 2：健康异常发现
系统发现猫 A 已经 24 小时没有进食记录，发送提醒通知。

### 场景 3：新猫注册
通过 Web 界面上传新猫的照片和描述，系统自动将其加入 AI 识别的参考库。

## 技术约束

- **成本控制**：Gemini 2.5 Flash 约 $0.0011/图片，预估每天 ~150 次调用 ≈ $0.17/天
- **延迟**：运动检测 < 10ms/帧，Gemini 分析 ~2-3 秒/帧（可接受，不是实时需求）
- **共享数据库**：所有表使用 `purrview_` 前缀，与 project-kalshi 共享 Supabase 项目

## 数据库表

| 表名 | 说明 |
|------|------|
| `purrview_cats` | 猫咪资料（名称、描述、参考照片 URL） |
| `purrview_feeding_events` | 进食事件（关联猫和食盆，记录食物量变化） |
| `purrview_frames` | 关键帧（关联进食事件，存储 Gemini 原始分析） |
| `purrview_food_bowls` | 食盆 ROI 配置（坐标、名称、激活状态） |

## 开发阶段

1. **Phase 1**：项目基础搭建（monorepo、数据库、项目骨架）
2. **Phase 2**：流捕获 + 运动检测
3. **Phase 3**：Gemini 集成 + 事件存储
4. **Phase 4**：Web 仪表板功能完善
5. **Phase 5**：部署 + 监控告警
